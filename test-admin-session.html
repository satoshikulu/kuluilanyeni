<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Session Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Admin Session & Notification Test</h1>
        <p>Test admin login and push notification with real session</p>
        
        <!-- Login Section -->
        <div class="test-section">
            <h3>Step 1: Admin Login</h3>
            <input type="email" id="email" placeholder="Admin Email" value="">
            <input type="password" id="password" placeholder="Admin Password" value="">
            <button onclick="loginAdmin()">Login as Admin</button>
            <div id="loginResult" class="result"></div>
        </div>

        <!-- Session Check -->
        <div class="test-section">
            <h3>Step 2: Check Session & Role</h3>
            <button onclick="checkSession()">Check Current Session</button>
            <div id="sessionResult" class="result"></div>
        </div>

        <!-- Notification Test -->
        <div class="test-section">
            <h3>Step 3: Send Test Notification</h3>
            <input type="text" id="testPhone" placeholder="Phone (optional)" value="">
            <input type="text" id="testTitle" placeholder="Notification Title" value="Test Notification">
            <input type="text" id="testBody" placeholder="Notification Body" value="This is a test notification from admin panel">
            <button onclick="sendNotification()">Send Notification</button>
            <div id="notificationResult" class="result"></div>
        </div>

        <!-- Logout -->
        <div class="test-section">
            <h3>Step 4: Logout</h3>
            <button onclick="logoutAdmin()">Logout</button>
            <div id="logoutResult" class="result"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        
        const supabaseUrl = 'https://tjoivjohhjoedtwzuopr.supabase.co'
        const supabaseAnonKey = ''
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey)
        
        window.loginAdmin = async function() {
            const result = document.getElementById('loginResult')
            result.className = 'result info'
            result.textContent = 'Logging in...'
            
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                })
                
                if (error) {
                    result.className = 'result error'
                    result.textContent = '‚ùå Login Error: ' + error.message
                    return
                }
                
                if (data.user) {
                    const userRole = data.user.user_metadata?.role
                    result.className = 'result success'
                    result.textContent = `‚úÖ Login Success!
User ID: ${data.user.id}
Email: ${data.user.email}
Role: ${userRole || 'No role'}
Is Admin: ${userRole === 'admin' ? 'YES' : 'NO'}
Session: ${data.session ? 'Active' : 'None'}
Token Preview: ${data.session?.access_token?.substring(0, 50)}...`
                } else {
                    result.className = 'result error'
                    result.textContent = '‚ùå No user data returned'
                }
            } catch (error) {
                result.className = 'result error'
                result.textContent = '‚ùå Exception: ' + error.message
            }
        }
        
        window.checkSession = async function() {
            const result = document.getElementById('sessionResult')
            result.className = 'result info'
            result.textContent = 'Checking session...'
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession()
                
                if (error) {
                    result.className = 'result error'
                    result.textContent = '‚ùå Session Error: ' + error.message
                    return
                }
                
                if (session) {
                    const userRole = session.user.user_metadata?.role
                    result.className = 'result success'
                    result.textContent = `‚úÖ Active Session Found!
User ID: ${session.user.id}
Email: ${session.user.email}
Role: ${userRole || 'No role'}
Is Admin: ${userRole === 'admin' ? 'YES' : 'NO'}
Token Type: ${session.token_type}
Expires At: ${new Date(session.expires_at * 1000).toLocaleString()}
Access Token Preview: ${session.access_token.substring(0, 50)}...`
                } else {
                    result.className = 'result error'
                    result.textContent = '‚ùå No active session found'
                }
            } catch (error) {
                result.className = 'result error'
                result.textContent = '‚ùå Exception: ' + error.message
            }
        }
        
        window.sendNotification = async function() {
            const result = document.getElementById('notificationResult')
            result.className = 'result info'
            result.textContent = 'Sending notification...'
            
            try {
                // Get current session
                const { data: { session } } = await supabase.auth.getSession()
                
                if (!session) {
                    result.className = 'result error'
                    result.textContent = '‚ùå No session found - please login first'
                    return
                }
                
                const phone = document.getElementById('testPhone').value.trim()
                const title = document.getElementById('testTitle').value.trim()
                const body = document.getElementById('testBody').value.trim()
                
                if (!title || !body) {
                    result.className = 'result error'
                    result.textContent = '‚ùå Title and body are required'
                    return
                }
                
                result.textContent = `Sending notification...
Using JWT: ${session.access_token.substring(0, 30)}...
Phone: ${phone || 'all users'}
Title: ${title}
Body: ${body}`
                
                const response = await fetch(`${supabaseUrl}/functions/v1/send-admin-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        phone: phone || null,
                        title: title,
                        body: body
                    })
                })
                
                console.log('Response status:', response.status)
                console.log('Response headers:', Object.fromEntries(response.headers.entries()))
                
                const responseText = await response.text()
                console.log('Response text:', responseText)
                
                let data
                try {
                    data = JSON.parse(responseText)
                } catch (jsonError) {
                    result.className = 'result error'
                    result.textContent = `‚ùå Non-JSON Response (${response.status}):
${responseText.substring(0, 500)}

This is the "Unexpected token '<'" error!
The Edge Function returned HTML instead of JSON.`
                    return
                }
                
                if (response.ok) {
                    result.className = 'result success'
                    result.textContent = `‚úÖ Notification Sent Successfully!
Status: ${response.status}
Response: ${JSON.stringify(data, null, 2)}`
                } else {
                    result.className = 'result error'
                    result.textContent = `‚ùå Notification Failed (${response.status}):
${JSON.stringify(data, null, 2)}`
                }
                
            } catch (error) {
                result.className = 'result error'
                result.textContent = '‚ùå Exception: ' + error.message
            }
        }
        
        window.logoutAdmin = async function() {
            const result = document.getElementById('logoutResult')
            result.className = 'result info'
            result.textContent = 'Logging out...'
            
            try {
                const { error } = await supabase.auth.signOut()
                
                if (error) {
                    result.className = 'result error'
                    result.textContent = '‚ùå Logout Error: ' + error.message
                } else {
                    result.className = 'result success'
                    result.textContent = '‚úÖ Logged out successfully'
                }
            } catch (error) {
                result.className = 'result error'
                result.textContent = '‚ùå Exception: ' + error.message
            }
        }
    </script>
</body>
</html>